\! sh ./sql/setup.sh
/*---- リポジトリDB初期化 ----*/
\! sh ./sql/function-snapshot1.sh
/*---- 監視対象インスタンス初期化 ----*/
CREATE TABLESPACE
CREATE SCHEMA
NOTICE:  CREATE TABLE will create implicit sequence "tbl01_id_seq" for serial column "tbl01.id"
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "tbl01_pkey" for table "tbl01"
CREATE TABLE
CREATE TABLE
CREATE FUNCTION
INSERT 0 1
INSERT 0 1

GRANT
vacuumdb: vacuuming database "db01"
vacuumdb: vacuuming database "postgres"
vacuumdb: vacuuming database "template1"
/*---- 統計情報取得機能(スナップショット取得) ----*/
/**--- データベース情報の収集 ---**/
 snapid | database | dbid | size | age | xact_commit | xact_rollback | blks_read | blks_hit | tup_returned | tup_fetched | tup_inserted | tup_updated | tup_deleted | confl_tablespace | confl_lock | confl_snapshot | confl_bufferpin | confl_deadlock | temp_files | temp_bytes | deadlocks | blk_read_time | blk_write_time 
--------+----------+------+------+-----+-------------+---------------+-----------+----------+--------------+-------------+--------------+-------------+-------------+------------------+------------+----------------+-----------------+----------------+------------+------------+-----------+---------------+----------------
      1 | db01     | xxx  | xxx  | xxx | xxx         | xxx           | xxx       | xxx      | xxx          | xxx         | xxx          | xxx         | xxx         | (N/A)            | (N/A)      | (N/A)          | (N/A)           | (N/A)          | (N/A)      | (N/A)      | (N/A)     | (N/A)         | (N/A)
      1 | postgres | xxx  | xxx  | xxx | xxx         | xxx           | xxx       | xxx      | xxx          | xxx         | xxx          | xxx         | xxx         | (N/A)            | (N/A)      | (N/A)          | (N/A)           | (N/A)          | (N/A)      | (N/A)      | (N/A)     | (N/A)         | (N/A)
(2 rows)

/**--- スキーマ情報の収集 ---**/
 snapid | database |     schema      | nsp 
--------+----------+-----------------+-----
      1 | db01     | pg_temp_1       | xxx
      1 | db01     | pg_toast_temp_1 | xxx
      1 | db01     | public          | xxx
      1 | db01     | schema01        | xxx
      1 | postgres | pg_temp_1       | xxx
      1 | postgres | pg_toast_temp_1 | xxx
      1 | postgres | public          | xxx
      1 | postgres | statsinfo       | xxx
(8 rows)

/**--- テーブル情報の収集 ---**/
 snapid | database |  schema  | table | tablespace | tbl | date | toastrelid | toastidxid | relkind | relpages | reltuples | reloptions | size | seq_scan | seq_tup_read | idx_scan | idx_tup_fetch | n_tup_ins | n_tup_upd | n_tup_del | n_tup_hot_upd | n_live_tup | n_dead_tup | heap_blks_read | heap_blks_hit | idx_blks_read | idx_blks_hit | toast_blks_read | toast_blks_hit | tidx_blks_read | tidx_blks_hit | last_vacuum | last_autovacuum | last_analyze | last_autoanalyze 
--------+----------+----------+-------+------------+-----+------+------------+------------+---------+----------+-----------+------------+------+----------+--------------+----------+---------------+-----------+-----------+-----------+---------------+------------+------------+----------------+---------------+---------------+--------------+-----------------+----------------+----------------+---------------+-------------+-----------------+--------------+------------------
      1 | db01     | schema01 | tbl01 | tblspc01   | xxx | xxx  | xxx        | xxx        | xxx     | xxx      | xxx       |            | xxx  | xxx      | xxx          | xxx      | xxx           | xxx       | xxx       | xxx       | xxx           | xxx        | xxx        | xxx            | xxx           | xxx           | xxx          | xxx             | xxx            | xxx            | xxx           | xxx         |                 | xxx          | 
      1 | db01     | schema01 | tbl02 | pg_default | xxx | xxx  | xxx        | xxx        | xxx     | xxx      | xxx       |            | xxx  | xxx      | xxx          |          |               | xxx       | xxx       | xxx       | xxx           | xxx        | xxx        | xxx            | xxx           |               |              | xxx             | xxx            | xxx            | xxx           | xxx         |                 | xxx          | 
(2 rows)

/**--- カラム情報の収集 ---**/
 snapid | database | table | column  | attnum |  type   | stattarget | storage | isnotnull | isdropped | date | avg_width | n_distinct | correlation 
--------+----------+-------+---------+--------+---------+------------+---------+-----------+-----------+------+-----------+------------+-------------
      1 | db01     | tbl01 | id      |      1 | integer |         -1 | p       | t         | f         | xxx  | xxx       | xxx        | xxx
      1 | db01     | tbl01 | name    |      2 | text    |         -1 | x       | f         | f         | xxx  | xxx       | xxx        | xxx
      1 | db01     | tbl01 | age     |      3 | integer |         -1 | p       | f         | f         | xxx  | xxx       | xxx        | xxx
      1 | db01     | tbl02 | id      |      1 | integer |         -1 | p       | t         | f         | xxx  | xxx       | xxx        | 
      1 | db01     | tbl02 | name    |      2 | text    |         -1 | x       | f         | f         | xxx  | xxx       | xxx        | 
      1 | db01     | tbl02 | age     |      3 | integer |         -1 | p       | f         | f         | xxx  | xxx       | xxx        | 
      1 | db01     | tbl02 | address |      4 | text    |         -1 | x       | f         | f         | xxx  | xxx       | xxx        | 
(7 rows)

/**--- インデックス情報の収集 ---**/
 snapid | database | table |   index    | tablespace | reloptions | isunique | isprimary | isclustered | isvalid | indkey |                             indexdef                              | date | relam | relpages | reltuples | size | idx_scan | idx_tup_read | idx_tup_fetch | idx_blks_read | idx_blks_hit 
--------+----------+-------+------------+------------+------------+----------+-----------+-------------+---------+--------+-------------------------------------------------------------------+------+-------+----------+-----------+------+----------+--------------+---------------+---------------+--------------
      1 | db01     | tbl01 | tbl01_pkey | pg_default |            | t        | t         | f           | t       | 1      | CREATE UNIQUE INDEX tbl01_pkey ON schema01.tbl01 USING btree (id) | xxx  | xxx   | xxx      | xxx       | xxx  | xxx      | xxx          | xxx           | xxx           | xxx
(1 row)

/**--- 継承テーブル情報の収集 ---**/
 snapid | database | table | parent | inhseqno 
--------+----------+-------+--------+----------
      1 | db01     | tbl02 | tbl01  |        1
(1 row)

/**--- ユーザ定義関数情報の収集 ---**/
 snapid | database |  schema  | funcname | funcid | argtypes | calls | total_time | self_time 
--------+----------+----------+----------+--------+----------+-------+------------+-----------
      1 | db01     | schema01 | func01   | xxx    | xxx      | xxx   | xxx        | xxx
(1 row)

/**--- CPU情報の収集 ---**/
 snapid | cpu_id | cpu_user | cpu_system | cpu_idle | cpu_iowait | overflow_user | overflow_system | overflow_idle | overflow_iowait 
--------+--------+----------+------------+----------+------------+---------------+-----------------+---------------+-----------------
      1 | xxx    | xxx      | xxx        | xxx      | xxx        | xxx           | xxx             | xxx           | xxx
(1 row)

/**--- ロードアベレージ情報の収集 ---**/
 snapid | loadavg1 | loadavg5 | loadavg15 
--------+----------+----------+-----------
      1 | xxx      | xxx      | xxx
(1 row)

/**--- メモリ情報の収集 ---**/
 snapid | memfree | buffers | cached | swap | dirty 
--------+---------+---------+--------+------+-------
      1 | xxx     | xxx     | xxx    | xxx  | xxx
(1 row)

/**--- ディスクI/O情報の収集 ---**/
 snapid | device_major | device_minor | device_name | device_readsector | device_readtime | device_writesector | device_writetime | device_ioqueue | device_iototaltime | overflow_drs | overflow_drt | overflow_dws | overflow_dwt | overflow_dit |                      device_tblspaces                       
--------+--------------+--------------+-------------+-------------------+-----------------+--------------------+------------------+----------------+--------------------+--------------+--------------+--------------+--------------+--------------+-------------------------------------------------------------
      1 | xxx          | xxx          | xxx         | xxx               | xxx             | xxx                | xxx              | xxx            | xxx                | xxx          | xxx          | xxx          | xxx          | xxx          | {pg_default,pg_global,tblspc01,<pg_xlog>,<pg_xlog_archive>}
(1 row)

/**--- テーブルスペース情報の収集 ---**/
 snapid |    tablespace     | tbs |      location      | device | avail | total | spcoptions 
--------+-------------------+-----+--------------------+--------+-------+-------+------------
      1 | <pg_xlog>         |     | $PGDATA/xlogdir    | xxx    | xxx   | xxx   | 
      1 | <pg_xlog_archive> |     | $PGDATA/archivelog | xxx    | xxx   | xxx   | 
      1 | pg_default        | xxx | $PGDATA            | xxx    | xxx   | xxx   | 
      1 | pg_global         | xxx | $PGDATA            | xxx    | xxx   | xxx   | 
      1 | tblspc01          | xxx | $PGDATA/tblspc01   | xxx    | xxx   | xxx   | 
(5 rows)

/**--- ロール情報の収集 ---**/
 snapid |   role   | userid 
--------+----------+--------
      1 | postgres | xxx
      1 | user01   | xxx
(2 rows)

/**--- データベース設定情報の収集 ---**/
 snapid |           name           |   setting    |       source       
--------+--------------------------+--------------+--------------------
      1 | logging_collector        | on           | override
      1 | port                     | 5440         | command line
      1 | shared_preload_libraries | pg_statsinfo | configuration file
(3 rows)

/**--- アクティビティ情報の収集 ---**/
/***-- バックエンドの各種状態種別の判別可否 --***/
CREATE TABLE
BEGIN
LOCK TABLE
COMMIT
DROP TABLE
 snapid | idle | idle_in_xact | waiting | running 
--------+------+--------------+---------+---------
      2 | OK   | OK           | OK      | OK
(1 row)

/***-- ロングトランザクション(1秒以上)が存在しない --***/
 snapid | max_xact_client | max_xact_pid | max_xact_start | max_xact_duration | max_xact_query 
--------+-----------------+--------------+----------------+-------------------+----------------
      3 | OK              | OK           | OK             | OK                | OK
(1 row)

/***-- ロングトランザクション(1秒以上)が存在する --***/
 snapid | max_xact_client | max_xact_pid | max_xact_start | max_xact_duration |              max_xact_query               
--------+-----------------+--------------+----------------+-------------------+-------------------------------------------
      4 | OK              | OK           | OK             | OK                | SELECT pg_backend_pid() FROM pg_sleep(10)
(1 row)

/**--- ロック競合情報の収集 ---**/
/***-- ロック競合が発生していない状態 --***/
 snapid | datname | nspname | relname | blocker_appname | blocker_addr | blocker_hostname | blocker_port | blockee_pid | blocker_pid | blocker_gid | duration | blockee_query | blocker_query 
--------+---------+---------+---------+-----------------+--------------+------------------+--------------+-------------+-------------+-------------+----------+---------------+---------------
(0 rows)

/***-- ロック競合が発生している状態 --***/
 snapid | datname | nspname | relname | blocker_appname | blocker_addr | blocker_hostname | blocker_port | blockee_pid | blocker_pid | blocker_gid | duration |                       blockee_query                       |            blocker_query             
--------+---------+---------+---------+-----------------+--------------+------------------+--------------+-------------+-------------+-------------+----------+-----------------------------------------------------------+--------------------------------------
      6 | db01    |         |         |                 |              |                  | xxx          | xxx         | xxx         |             | xxx      | LOCK TABLE schema01.tbl01 IN ACCESS SHARE MODE;           | (library might not have been loaded)
      6 | db01    |         |         |                 |              |                  | xxx          | xxx         | xxx         |             | xxx      | LOCK TABLE schema01.tbl01 IN SHARE UPDATE EXCLUSIVE MODE; | (library might not have been loaded)
(2 rows)

/**--- WAL情報の収集 ---**/
/***-- 監視対象インスタンスがスタンドアローン構成 --***/
 snapid | location | xlogfile 
--------+----------+----------
      6 | xxx      | xxx
(1 row)

/**--- レプリケーション情報の収集 ---**/
/***-- 監視対象インスタンスがスタンドアローン構成 --***/
 snapid | procpid | usesysid | usename | application_name | client_addr | client_hostname | client_port | backend_start | state | current_location | sent_location | write_location | flush_location | replay_location | sync_priority | sync_state 
--------+---------+----------+---------+------------------+-------------+-----------------+-------------+---------------+-------+------------------+---------------+----------------+----------------+-----------------+---------------+------------
(0 rows)

/**--- クエリの統計情報の収集 ---**/
/***-- pg_stat_statementsがインストールされていない --***/
 snapid | dbid | userid | query | calls | total_time | rows | shared_blks_hit | shared_blks_read | shared_blks_dirtied | shared_blks_written | local_blks_hit | local_blks_read | local_blks_dirtied | local_blks_written | temp_blks_read | temp_blks_written | blk_read_time | blk_write_time 
--------+------+--------+-------+-------+------------+------+-----------------+------------------+---------------------+---------------------+----------------+-----------------+--------------------+--------------------+----------------+-------------------+---------------+----------------
(0 rows)

/***-- pg_stat_statementsがインストールされている --***/
SET
CREATE FUNCTION
CREATE FUNCTION
CREATE VIEW
GRANT
REVOKE
 snapid | database |  role  |               query                | calls | total_time | rows | shared_blks_hit | shared_blks_read | shared_blks_dirtied | shared_blks_written | local_blks_hit | local_blks_read | local_blks_dirtied | local_blks_written | temp_blks_read | temp_blks_written | blk_read_time | blk_write_time 
--------+----------+--------+------------------------------------+-------+------------+------+-----------------+------------------+---------------------+---------------------+----------------+-----------------+--------------------+--------------------+----------------+-------------------+---------------+----------------
      7 | db01     | user01 | SELECT schema01.func01('yyy', 25); |     1 | xxx        | xxx  | (N/A)           | (N/A)            | (N/A)               | (N/A)               | (N/A)          | (N/A)           | (N/A)              | (N/A)              | (N/A)          | (N/A)             | (N/A)         | (N/A)
(1 row)

\! sh ./sql/function-snapshot2.sh
\! sh ./sql/function-logger.sh
/*---- 監視対象インスタンス初期化 ----*/
CREATE TABLE
CREATE FUNCTION
/*---- サーバログ処理機能 ----*/
/**--- 最新テキストログのファイルとアクセス権限の設定 ---**/
postgresql-statsinfo.log -rw-r--r--(644)
server signaled
postgresql.log -rw-rw-rw-(666)
/**--- サーバログの分配 (textlog_min_messages = disable) ---**/
server signaled
INFO:  textlog routing test (disable)
NOTICE:  textlog routing test (disable)
WARNING:  textlog routing test (disable)
ERROR:  textlog routing test (disable)
/**--- サーバログの分配 (textlog_min_messages = error) ---**/
server signaled
INFO:  textlog routing test (error)
NOTICE:  textlog routing test (error)
WARNING:  textlog routing test (error)
ERROR:  textlog routing test (error)
00000 LOG:  textlog routing test (error)
00000 STATEMENT:  SELECT statsinfo.elog('ALL', 'textlog routing test (error)')
P0001 ERROR:  textlog routing test (error)
P0001 STATEMENT:  SELECT statsinfo.elog('ALL', 'textlog routing test (error)')
/**--- ログレベル制御 (adjust_log_level = off) ---**/
server signaled
42P01 ERROR:  relation "xxx" does not exist at character 15
42P01 STATEMENT:  SELECT * FROM xxx
/**--- ログレベル制御 (adjust_log_info = '42P01') ---**/
server signaled
42P01 INFO:  relation "xxx" does not exist at character 15
42P01 STATEMENT:  SELECT * FROM xxx
/**--- ログレベル制御 (adjust_log_notice = '42P01') ---**/
server signaled
42P01 NOTICE:  relation "xxx" does not exist at character 15
42P01 STATEMENT:  SELECT * FROM xxx
/**--- ログレベル制御 (adjust_log_warning = '42P01') ---**/
server signaled
42P01 WARNING:  relation "xxx" does not exist at character 15
42P01 STATEMENT:  SELECT * FROM xxx
/**--- ログレベル制御 (adjust_log_error = '00000') ---**/
server signaled
00000 ERROR:  statement: SELECT 1
/**--- ログレベル制御 (adjust_log_log = '42P01') ---**/
server signaled
42P01 LOG:  relation "xxx" does not exist at character 15
42P01 STATEMENT:  SELECT * FROM xxx
/**--- ログレベル制御 (adjust_log_fatal = '42P01') ---**/
server signaled
42P01 FATAL:  relation "xxx" does not exist at character 15
42P01 STATEMENT:  SELECT * FROM xxx
/**--- テキストログのフィルタリング設定 (textlog_nologging_users = 'user01') ---**/
server signaled
00000 LOG:  statement: SELECT 1
/**--- テキストログのフィルタリング設定 (textlog_nologging_users = 'user01, user02') ---**/
server signaled
00000 LOG:  statement: SELECT 1
/**--- チェックポイント情報の収集 ---**/
CHECKPOINT
INSERT 0 1
 instid |        flags         | start | num_buffers | xlog_added | xlog_removed | xlog_recycled | write_duration | sync_duration | total_duration 
--------+----------------------+-------+-------------+------------+--------------+---------------+----------------+---------------+----------------
      2 | immediate force wait | xxx   | xxx         | xxx        | xxx          | xxx           | xxx            | xxx           | xxx
      2 | time                 | xxx   | xxx         | xxx        | xxx          | xxx           | xxx            | xxx           | xxx
      2 | xlog                 | xxx   | xxx         | xxx        | xxx          | xxx           | xxx            | xxx           | xxx
(3 rows)

/**--- AUTOANALYZE情報の収集 ---**/
server signaled
INSERT 0 10000
DELETE 4001
 instid | database | schema | table | start | duration 
--------+----------+--------+-------+-------+----------
      2 | postgres | public | tbl01 | xxx   | xxx
(1 row)

/**--- AUTOVACUUM情報の収集 ---**/
 instid | database | schema | table | start | index_scans | page_removed | page_remain | tup_removed | tup_remain | page_hit | page_miss | page_dirty | read_rate | write_rate | duration 
--------+----------+--------+-------+-------+-------------+--------------+-------------+-------------+------------+----------+-----------+------------+-----------+------------+----------
      2 | postgres | public | tbl01 | xxx   | xxx         | xxx          | xxx         | xxx         | xxx        | (N/A)    | (N/A)     | (N/A)      | (N/A)     | (N/A)      | xxx
(1 row)

\! sh ./sql/function-alert.sh
/*---- 監視対象インスタンス初期化 ----*/
SET
CREATE FUNCTION
CREATE FUNCTION
CREATE VIEW
GRANT
REVOKE
/*---- アラート機能 ----*/
/**--- 秒間ロールバック数の判定 ---**/
UPDATE 3
BEGIN
CREATE TABLE
ROLLBACK
ANALYZE
ALERT:  pg_statsinfo: too many rollbacks in snapshots between 'xxx' and 'xxx' --- xxx Rollbacks/sec
UPDATE 3
/**--- 秒間コミット数の判定 ---**/
UPDATE 3
BEGIN
CREATE TABLE
COMMIT
ANALYZE
ALERT:  pg_statsinfo: too many transactions in snapshots between 'xxx' and 'xxx' --- xxx Transactions/sec
UPDATE 3
/**--- クエリの平均レスポンス時間の判定 ---**/
UPDATE 3
ALERT:  pg_statsinfo: Query average response exceeds threshold in snapshots between 'xxx' and 'xxx' --- xxx sec
UPDATE 3
/**--- クエリの最長レスポンス時間の判定 ---**/
UPDATE 3
ALERT:  pg_statsinfo: Query worst response exceeds threshold in snapshots between 'xxx' and 'xxx' --- xxx sec
UPDATE 3
/**--- 不要領域のサイズ／割合の判定 ---**/
UPDATE 3
CREATE TABLE
CREATE TABLE
INSERT 0 500000
INSERT 0 500000
DELETE 400000
DELETE 300000
ANALYZE
ALERT:  pg_statsinfo: dead tuple size exceeds threashold in snapshots between 'xxx' and 'xxx' --- xxx MiB
ALERT:  pg_statsinfo: dead tuple ratio exceeds threashold in snapshots between 'xxx' and 'xxx' --- xxx %
ALERT:  pg_statsinfo: dead tuple ratio in postgres.public.tbl02 exceeds threashold in snapshots between 'xxx' and 'xxx' --- xxx %
UPDATE 3
\! sh ./sql/function-maintenance.sh
/*---- リポジトリDB初期化 ----*/
/*---- 監視対象インスタンス初期化 ----*/
/*---- 自動メンテナンス機能 ----*/
/**--- スナップショット削除 ---**/
 snapid |  comment   
--------+------------
      1 | 2 days ago
      2 | 1 days ago
      3 | today
(3 rows)

UPDATE 1
UPDATE 1
server signaled
 snapid |  comment   
--------+------------
      2 | 1 days ago
      3 | today
(2 rows)

/**--- ログファイル整理 ---**/
server signaled
log maintenance command called
\! sh ./sql/cleanup.sh
