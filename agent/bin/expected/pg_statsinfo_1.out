\! sh ./sql/setup.sh
/*---- Initialize repository DB ----*/
\! sh ./sql/function-snapshot1.sh
/*---- Initialize monitored instance ----*/
CREATE TABLESPACE
CREATE SCHEMA
NOTICE:  CREATE TABLE will create implicit sequence "tbl01_id_seq" for serial column "tbl01.id"
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "tbl01_pkey" for table "tbl01"
CREATE TABLE
CREATE TABLE
CREATE FUNCTION
INSERT 0 1
INSERT 0 1

GRANT
vacuumdb: vacuuming database "db01"
vacuumdb: vacuuming database "postgres"
vacuumdb: vacuuming database "template1"
/*---- Statistics collection function ----*/
/**--- Statistics of database ---**/
 snapid | database | dbid | size | age | xact_commit | xact_rollback | blks_read | blks_hit | tup_returned | tup_fetched | tup_inserted | tup_updated | tup_deleted | confl_tablespace | confl_lock | confl_snapshot | confl_bufferpin | confl_deadlock | temp_files | temp_bytes | deadlocks | blk_read_time | blk_write_time 
--------+----------+------+------+-----+-------------+---------------+-----------+----------+--------------+-------------+--------------+-------------+-------------+------------------+------------+----------------+-----------------+----------------+------------+------------+-----------+---------------+----------------
      1 | db01     | xxx  | xxx  | xxx | xxx         | xxx           | xxx       | xxx      | xxx          | xxx         | xxx          | xxx         | xxx         | (N/A)            | (N/A)      | (N/A)          | (N/A)           | (N/A)          | (N/A)      | (N/A)      | (N/A)     | (N/A)         | (N/A)
      1 | postgres | xxx  | xxx  | xxx | xxx         | xxx           | xxx       | xxx      | xxx          | xxx         | xxx          | xxx         | xxx         | (N/A)            | (N/A)      | (N/A)          | (N/A)           | (N/A)          | (N/A)      | (N/A)      | (N/A)     | (N/A)         | (N/A)
(2 rows)

/**--- Statistics of schema ---**/
 snapid | database |     schema      | nsp 
--------+----------+-----------------+-----
      1 | db01     | pg_temp_1       | xxx
      1 | db01     | pg_toast_temp_1 | xxx
      1 | db01     | public          | xxx
      1 | db01     | schema01        | xxx
      1 | postgres | pg_temp_1       | xxx
      1 | postgres | pg_toast_temp_1 | xxx
      1 | postgres | public          | xxx
      1 | postgres | statsinfo       | xxx
(8 rows)

/**--- Statistics of table ---**/
 snapid | database |  schema  | table | tablespace | tbl | date | toastrelid | toastidxid | relkind | relpages | reltuples | reloptions | size | seq_scan | seq_tup_read | idx_scan | idx_tup_fetch | n_tup_ins | n_tup_upd | n_tup_del | n_tup_hot_upd | n_live_tup | n_dead_tup | heap_blks_read | heap_blks_hit | idx_blks_read | idx_blks_hit | toast_blks_read | toast_blks_hit | tidx_blks_read | tidx_blks_hit | last_vacuum | last_autovacuum | last_analyze | last_autoanalyze 
--------+----------+----------+-------+------------+-----+------+------------+------------+---------+----------+-----------+------------+------+----------+--------------+----------+---------------+-----------+-----------+-----------+---------------+------------+------------+----------------+---------------+---------------+--------------+-----------------+----------------+----------------+---------------+-------------+-----------------+--------------+------------------
      1 | db01     | schema01 | tbl01 | tblspc01   | xxx | xxx  | xxx        | xxx        | xxx     | xxx      | xxx       |            | xxx  | xxx      | xxx          | xxx      | xxx           | xxx       | xxx       | xxx       | xxx           | xxx        | xxx        | xxx            | xxx           | xxx           | xxx          | xxx             | xxx            | xxx            | xxx           | xxx         |                 | xxx          | 
      1 | db01     | schema01 | tbl02 | pg_default | xxx | xxx  | xxx        | xxx        | xxx     | xxx      | xxx       |            | xxx  | xxx      | xxx          |          |               | xxx       | xxx       | xxx       | xxx           | xxx        | xxx        | xxx            | xxx           |               |              | xxx             | xxx            | xxx            | xxx           | xxx         |                 | xxx          | 
(2 rows)

/**--- Statistics of column ---**/
 snapid | database | table | column  | attnum |  type   | stattarget | storage | isnotnull | isdropped | date | avg_width | n_distinct | correlation 
--------+----------+-------+---------+--------+---------+------------+---------+-----------+-----------+------+-----------+------------+-------------
      1 | db01     | tbl01 | id      |      1 | integer |         -1 | p       | t         | f         | xxx  | xxx       | xxx        | xxx
      1 | db01     | tbl01 | name    |      2 | text    |         -1 | x       | f         | f         | xxx  | xxx       | xxx        | xxx
      1 | db01     | tbl01 | age     |      3 | integer |         -1 | p       | f         | f         | xxx  | xxx       | xxx        | xxx
      1 | db01     | tbl02 | id      |      1 | integer |         -1 | p       | t         | f         | xxx  | xxx       | xxx        | 
      1 | db01     | tbl02 | name    |      2 | text    |         -1 | x       | f         | f         | xxx  | xxx       | xxx        | 
      1 | db01     | tbl02 | age     |      3 | integer |         -1 | p       | f         | f         | xxx  | xxx       | xxx        | 
      1 | db01     | tbl02 | address |      4 | text    |         -1 | x       | f         | f         | xxx  | xxx       | xxx        | 
(7 rows)

/**--- Statistics of index ---**/
 snapid | database | table |   index    | tablespace | reloptions | isunique | isprimary | isclustered | isvalid | indkey |                             indexdef                              | date | relam | relpages | reltuples | size | idx_scan | idx_tup_read | idx_tup_fetch | idx_blks_read | idx_blks_hit 
--------+----------+-------+------------+------------+------------+----------+-----------+-------------+---------+--------+-------------------------------------------------------------------+------+-------+----------+-----------+------+----------+--------------+---------------+---------------+--------------
      1 | db01     | tbl01 | tbl01_pkey | pg_default |            | t        | t         | f           | t       | 1      | CREATE UNIQUE INDEX tbl01_pkey ON schema01.tbl01 USING btree (id) | xxx  | xxx   | xxx      | xxx       | xxx  | xxx      | xxx          | xxx           | xxx           | xxx
(1 row)

/**--- Statistics of inherits ---**/
 snapid | database | table | parent | inhseqno 
--------+----------+-------+--------+----------
      1 | db01     | tbl02 | tbl01  |        1
(1 row)

/**--- Statistics of SQL function ---**/
 snapid | database | schema | funcname | funcid | argtypes | calls | total_time | self_time 
--------+----------+--------+----------+--------+----------+-------+------------+-----------
(0 rows)

/**--- OS resource usage (CPU) ---**/
 snapid | cpu_id | cpu_user | cpu_system | cpu_idle | cpu_iowait | overflow_user | overflow_system | overflow_idle | overflow_iowait 
--------+--------+----------+------------+----------+------------+---------------+-----------------+---------------+-----------------
      1 | xxx    | xxx      | xxx        | xxx      | xxx        | xxx           | xxx             | xxx           | xxx
(1 row)

/**--- OS resource usage (loadavg) ---**/
 snapid | loadavg1 | loadavg5 | loadavg15 
--------+----------+----------+-----------
      1 | xxx      | xxx      | xxx
(1 row)

/**--- OS resource usage (memory) ---**/
 snapid | memfree | buffers | cached | swap | dirty 
--------+---------+---------+--------+------+-------
      1 | xxx     | xxx     | xxx    | xxx  | xxx
(1 row)

/**--- OS resource usage (disk I/O) ---**/
 snapid | device_major | device_minor | device_name | device_readsector | device_readtime | device_writesector | device_writetime | device_ioqueue | device_iototaltime | overflow_drs | overflow_drt | overflow_dws | overflow_dwt | overflow_dit |                      device_tblspaces                       
--------+--------------+--------------+-------------+-------------------+-----------------+--------------------+------------------+----------------+--------------------+--------------+--------------+--------------+--------------+--------------+-------------------------------------------------------------
      1 | xxx          | xxx          | xxx         | xxx               | xxx             | xxx                | xxx              | xxx            | xxx                | xxx          | xxx          | xxx          | xxx          | xxx          | {pg_default,pg_global,tblspc01,<pg_xlog>,<pg_xlog_archive>}
(1 row)

/**--- Statistics of tablespace ---**/
 snapid |    tablespace     | tbs |      location      | device | avail | total | spcoptions 
--------+-------------------+-----+--------------------+--------+-------+-------+------------
      1 | <pg_xlog>         |     | $PGDATA/xlogdir    | xxx    | xxx   | xxx   | 
      1 | <pg_xlog_archive> |     | $PGDATA/archivelog | xxx    | xxx   | xxx   | 
      1 | pg_default        | xxx | $PGDATA            | xxx    | xxx   | xxx   | 
      1 | pg_global         | xxx | $PGDATA            | xxx    | xxx   | xxx   | 
      1 | tblspc01          | xxx | $PGDATA/tblspc01   | xxx    | xxx   | xxx   | 
(5 rows)

/**--- Role information ---**/
 snapid |   role   | userid 
--------+----------+--------
      1 | postgres | xxx
      1 | user01   | xxx
(2 rows)

/**--- GUC setting ---**/
 snapid |           name           |   setting    |       source       
--------+--------------------------+--------------+--------------------
      1 | logging_collector        | on           | override
      1 | port                     | 5440         | command line
      1 | shared_preload_libraries | pg_statsinfo | configuration file
(3 rows)

/**--- Instance activity ---**/
/***-- Verify that can determine the state type of bakend --***/
CREATE TABLE
BEGIN
LOCK TABLE
COMMIT
DROP TABLE
 snapid | idle | idle_in_xact | waiting | running 
--------+------+--------------+---------+---------
      2 | OK   | OK           | OK      | OK
(1 row)

/***-- There is no transaction of more than 1 second --***/
 snapid | max_xact_client | max_xact_pid | max_xact_start | max_xact_duration | max_xact_query 
--------+-----------------+--------------+----------------+-------------------+----------------
      3 | OK              | OK           | OK             | OK                | OK
(1 row)

/***-- There is a transaction of more than 1 second --***/
 snapid | max_xact_client | max_xact_pid | max_xact_start | max_xact_duration |              max_xact_query               
--------+-----------------+--------------+----------------+-------------------+-------------------------------------------
      4 | OK              | OK           | OK             | OK                | SELECT pg_backend_pid() FROM pg_sleep(10)
(1 row)

/**--- Lock conflicts ---**/
/***-- There is no lock conflicts --***/
 snapid | datname | nspname | relname | blocker_appname | blocker_addr | blocker_hostname | blocker_port | blockee_pid | blocker_pid | blocker_gid | duration | blockee_query | blocker_query 
--------+---------+---------+---------+-----------------+--------------+------------------+--------------+-------------+-------------+-------------+----------+---------------+---------------
(0 rows)

/***-- There are lock conflicts --***/
 snapid | datname | nspname | relname | blocker_appname | blocker_addr | blocker_hostname | blocker_port | blockee_pid | blocker_pid | blocker_gid | duration |                       blockee_query                       | blocker_query 
--------+---------+---------+---------+-----------------+--------------+------------------+--------------+-------------+-------------+-------------+----------+-----------------------------------------------------------+---------------
      6 | db01    |         |         |                 |              |                  | xxx          | xxx         | xxx         |             | xxx      | LOCK TABLE schema01.tbl01 IN ACCESS SHARE MODE;           | 
      6 | db01    |         |         |                 |              |                  | xxx          | xxx         | xxx         |             | xxx      | LOCK TABLE schema01.tbl01 IN SHARE UPDATE EXCLUSIVE MODE; | 
(2 rows)

/**--- Statistics of WAL ---**/
/***-- Monitored instance is a stand-alone configuration --***/
 snapid | location | xlogfile 
--------+----------+----------
      6 | xxx      | xxx
(1 row)

/**--- Statistics of replication ---**/
/***-- Monitored instance is a stand-alone configuration --***/
 snapid | procpid | usesysid | usename | application_name | client_addr | client_hostname | client_port | backend_start | state | current_location | sent_location | write_location | flush_location | replay_location | sync_priority | sync_state 
--------+---------+----------+---------+------------------+-------------+-----------------+-------------+---------------+-------+------------------+---------------+----------------+----------------+-----------------+---------------+------------
(0 rows)

/**--- Statistics of query ---**/
/***-- pg_stat_statements is not installed --***/
 snapid | dbid | userid | query | calls | total_time | rows | shared_blks_hit | shared_blks_read | shared_blks_dirtied | shared_blks_written | local_blks_hit | local_blks_read | local_blks_dirtied | local_blks_written | temp_blks_read | temp_blks_written | blk_read_time | blk_write_time 
--------+------+--------+-------+-------+------------+------+-----------------+------------------+---------------------+---------------------+----------------+-----------------+--------------------+--------------------+----------------+-------------------+---------------+----------------
(0 rows)

\! sh ./sql/function-snapshot2.sh
\! sh ./sql/function-logger.sh
/*---- Initialize monitored instance ----*/
CREATE TABLE
CREATE FUNCTION
/*---- Server log filter ----*/
/**--- Sets the textlog's filename and access permission ---**/
postgresql-statsinfo.log -rw-r--r--(644)
server signaled
postgresql.log -rw-rw-rw-(666)
/**--- Textlog routing (textlog_min_messages = disable) ---**/
server signaled
INFO:  textlog routing test (disable)
NOTICE:  textlog routing test (disable)
WARNING:  textlog routing test (disable)
ERROR:  textlog routing test (disable)
/**--- Textlog routing (textlog_min_messages = error) ---**/
server signaled
INFO:  textlog routing test (error)
NOTICE:  textlog routing test (error)
WARNING:  textlog routing test (error)
ERROR:  textlog routing test (error)
00000 LOG:  textlog routing test (error)
00000 STATEMENT:  SELECT statsinfo.elog('ALL', 'textlog routing test (error)')
P0001 ERROR:  textlog routing test (error)
P0001 STATEMENT:  SELECT statsinfo.elog('ALL', 'textlog routing test (error)')
/**--- Textlog routing (adjust_log_level = off) ---**/
server signaled
42P01 ERROR:  relation "xxx" does not exist
42P01 STATEMENT:  SELECT * FROM xxx
/**--- Adjust log level (adjust_log_info = '42P01') ---**/
server signaled
42P01 INFO:  relation "xxx" does not exist
42P01 STATEMENT:  SELECT * FROM xxx
/**--- Adjust log level (adjust_log_notice = '42P01') ---**/
server signaled
42P01 NOTICE:  relation "xxx" does not exist
42P01 STATEMENT:  SELECT * FROM xxx
/**--- Adjust log level (adjust_log_warning = '42P01') ---**/
server signaled
42P01 WARNING:  relation "xxx" does not exist
42P01 STATEMENT:  SELECT * FROM xxx
/**--- Adjust log level (adjust_log_error = '00000') ---**/
server signaled
00000 ERROR:  statement: SELECT 1
/**--- Adjust log level (adjust_log_log = '42P01') ---**/
server signaled
42P01 LOG:  relation "xxx" does not exist
42P01 STATEMENT:  SELECT * FROM xxx
/**--- Adjust log level (adjust_log_fatal = '42P01') ---**/
server signaled
42P01 FATAL:  relation "xxx" does not exist
42P01 STATEMENT:  SELECT * FROM xxx
/**--- Sets the nologging filter (textlog_nologging_users = 'user01') ---**/
server signaled
00000 LOG:  statement: SELECT 1
/**--- Sets the nologging filter (textlog_nologging_users = 'user01, user02') ---**/
server signaled
00000 LOG:  statement: SELECT 1
/**--- Collect the CHECKPOINT information ---**/
CHECKPOINT
INSERT 0 1
 instid |        flags         | start | num_buffers | xlog_added | xlog_removed | xlog_recycled | write_duration | sync_duration | total_duration 
--------+----------------------+-------+-------------+------------+--------------+---------------+----------------+---------------+----------------
      2 | immediate force wait | xxx   | xxx         | xxx        | xxx          | xxx           | xxx            | xxx           | xxx
      2 | time                 | xxx   | xxx         | xxx        | xxx          | xxx           | xxx            | xxx           | xxx
      2 | xlog                 | xxx   | xxx         | xxx        | xxx          | xxx           | xxx            | xxx           | xxx
(3 rows)

/**--- Collect the AUTOANALYZE information ---**/
server signaled
INSERT 0 10000
DELETE 4001
 instid | database | schema | table | start | duration 
--------+----------+--------+-------+-------+----------
      2 | postgres | public | tbl01 | xxx   | xxx
(1 row)

/**--- Collect the AUOVACUUM information ---**/
 instid | database | schema | table | start | index_scans | page_removed | page_remain | tup_removed | tup_remain | page_hit | page_miss | page_dirty | read_rate | write_rate | duration 
--------+----------+--------+-------+-------+-------------+--------------+-------------+-------------+------------+----------+-----------+------------+-----------+------------+----------
      2 | postgres | public | tbl01 | xxx   | xxx         | xxx          | xxx         | xxx         | xxx        | (N/A)    | (N/A)     | (N/A)      | (N/A)     | (N/A)      | xxx
(1 row)

\! sh ./sql/function-alert.sh
/*---- Initialize monitored instance ----*/
/*---- Alert Function ----*/
/**--- Alert the number of rollbacks per second ---**/
UPDATE 3
BEGIN
CREATE TABLE
ROLLBACK
ANALYZE
ALERT:  pg_statsinfo: too many rollbacks in snapshots between 'xxx' and 'xxx' --- xxx Rollbacks/sec
UPDATE 3
/**--- Alert the number of commits per second ---**/
UPDATE 3
BEGIN
CREATE TABLE
COMMIT
ANALYZE
ALERT:  pg_statsinfo: too many transactions in snapshots between 'xxx' and 'xxx' --- xxx Transactions/sec
UPDATE 3
/**--- Alert the dead tuple size and ratio ---**/
UPDATE 3
CREATE TABLE
CREATE TABLE
INSERT 0 500000
INSERT 0 500000
DELETE 400000
DELETE 300000
ANALYZE
ALERT:  pg_statsinfo: dead tuple size exceeds threashold in snapshots between 'xxx' and 'xxx' --- xxx MiB
ALERT:  pg_statsinfo: dead tuple ratio exceeds threashold in snapshots between 'xxx' and 'xxx' --- xxx %
ALERT:  pg_statsinfo: dead tuple ratio in postgres.public.tbl02 exceeds threashold in snapshots between 'xxx' and 'xxx' --- xxx %
UPDATE 3
\! sh ./sql/function-maintenance.sh
/*---- Initialize repository schema ----*/
/*---- Initialize monitored instance ----*/
/*---- Automatic maintenance function ----*/
/**--- Delete the snapshot for a certain period of time has elapsed ---**/
 snapid |  comment   
--------+------------
      1 | 2 days ago
      2 | 1 days ago
      3 | today
(3 rows)

UPDATE 1
UPDATE 1
server signaled
 snapid |  comment   
--------+------------
      2 | 1 days ago
      3 | today
(2 rows)

/**--- Server log maintenance ---**/
server signaled
log maintenance command called
\! sh ./sql/cleanup.sh
