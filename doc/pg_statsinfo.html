<!DOCTYPE html PUBLIC "-//W3C//DTD html 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>pg_statsinfo</title>
<link rel="home" title="pg_statsinfo" href="index.html">
<link rel="stylesheet" TYPE="text/css"href="style.css">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>

<body>
<div class="index">
<ol>
<li><a href="#name">What is pg_statsinfo?</a></li>
<li><a href="#description">Description</a></li>
<ol>
  <li><a href="#features-snapshot">Statistics Snapshot</a></li>
  <li><a href="#features-log">Server Log Filter</a></li>
  <li><a href="#features-alert">Alert Function</a></li>
  <li><a href="#features-cmdline">Feature of Command-line</a></li>
  <li><a href="#features-maintenance">auto-maintenanced repository</a></li>
</ol>
<li><a href="#install">Install</a>
<ol>
  <li><a href="#requirement">Rquirement</a></li>
  <li><a href="#procedure">Instlation</a></li>
</ol>
</li>
<li><a href="#usage">Usage</a></li>
<ol>
  <li><a href="#start-or-stop">Start or Stop</a></li>
  <li><a href="#snapshot">Get Snapshot</a></li>
  <li><a href="#log">Output of Logfile</a></li>
  <li><a href="#usage-alert">Alert Function</a></li>
  <li><a href="#usage-cmdline">How to Use Feature of Command-line</a></li>
  <li><a href="#usage-maintenance">How tou Use Feature of Auto-maintenaced Repository</a></li>
  <li><a href="#configuration">Configuration</a></li>
  <li><a href="#user-operations">Needed Your Work in Operations</a></li>
</ol>
<li><a href="#uninstall">Uninstall</a></li>
<li><a href="#restrictions">Restrictions</a></li>
<li><a href="#QA">Q&A</a></li>
<li><a href="#change">Changes from pg_statsinfo 2.4</a></li>
<li><a href="#details">Details</a></li>
<ol>
  <li><a href="#many-instances">Multiple Instance and One Repository</a></li>
  <li><a href="#warm-standby">Warm Standby</a></li>
  <li><a href="#fallback-mode">Fall-Back Mode</a></li>
  <li><a href="#internal">Internals</a></li>
</ol>
<li><a href="#seealso">See Also</a></li>
</ol>
</div>
<h1 id="pg_statsinfo">pg_statsinfo 2.5</h1>
<h2 id="name">What is pg_statsinfo ?</h2>
<p>pg_statsinfo -- monitor statistics and activities of PostgreSQL server.
It is easy to use pg_statsinfo that pg_statsinfo is working with PostgreSQL start or stop. 
</p>


<h2 id="description">Description</h2>
<p>pg_statsinfo monitors an instance of PostgreSQL server and gather the statistics and activities of the server as snapshots.
The snapshots will be stored in the same or another repository database.
It also parses PostgreSQL's CSV server log files and extracts performance logs from them.
Error messages are routed into text log and syslog according to the message levels.</p>

<p>pg_statsinfo can be easily installed and maintained because it starts or stops automatically when PostgreSQL server starts or stops.
Also configuration parameters are integrated with setting files of the server.
Statistics counters from pg_statsinfo can be displayed with <a href="http://pgstatsinfo.projects.postgresql.org/pg_stats_reporter.html">pg_stats_reporter</a> as graphical reports.</p>

<p>Represent a system structure image which is installed pg_statsinfo</p>

<div class="imagebox">
  <p class="image"><img src="image/system_structure.png"></p>
  <p class="caption">pic1: Example of system installed with pg_statsinfo</p>
</div>
<div class="imagebox">
  <p class="image"><img src="image/pg_statsinfo.png"></p>
  <p class="caption">pic2: Image of Functionary in pg_statsinfo</p>
</div>
<p class="clear"/>

<h3 id="features-snapshot">Statistics Snapshot</h3>
<p>
pg_statsinfo gathers statistics periodically and stores them as snapshots into a repository database.
The repository can be in the same database with the monitored instance or in another instance.
Also, one repository can store snapshots from multiple monitored instances.
</p>

<ul>
  <li>Snapshots are gathered periodically (default: every 10 minutes) or by manual.</li>
  <li>An event handler function is called after every snapshots taken.
      The function can be defined by users.
      A new snapshot can be compared with previous snapshots and raise alert messages in the function.
  </li>
</ul>

<p>Snapshot holds the following statistics information:</p>
<ul>
  <li>All of the information collected by <a href="http://developer.postgresql.org/pgdocs/postgres/monitoring-stats.html">the statistics collector</a>.
      For example, numbers of INSERT/UPDATE/DELETE and buffer access counters.</li>
  <li>Disk usages of each tablespace, pg_xlog, and archive log directory.</li>
  <li>Long transactions and their query strings.</li>
  <li>Process status in running, waiting for locks, idles in transaction, and idle.</li>
  <li>Amount of WAL output size.</li>
  <li>Number of CHECKPOINT ,VACUUM execution time and access of buffers.</li>
  <li>SQLs and functions that take long time.</li>
  <li>PostgreSQL configuration parameters.</li>
  <li>OS resource information(Usage of CPU, Memory, Disk I/O, Load Average)</li>
  <li>Lock information</li>
  <li>Number of canceled queries which conflicts recovery</li>
  <li>State fo replication</li>
</ul>

<p>
Size of a snapshot depends on the numbers of objects in DB. There are about 600 - 800kB per snapshot.
In case of pg_statsinfo default settings, snapshots for each monitored DB requires 90 - 120MB per day.
</p>

<p>Note that pg_statsinfo doesn't delete old snapshots.
Please delete them manually.</p>

<h3 id="features-log">Server Log Filter</h3>
<ul>
  <li>Split server log lines according to the message levels.
      You can set different message threshold for csvlog, textlog, and syslog.</li>
  <li>Fix filename of the textlog.
      The default is $PGDATA/pg_log/pg_statsinfo.log.
      You can always read the latest log in the same filename and setup of log monitoring tools would be easier.</li>
  <li>Set arbitrary access permission for each textlog files.
      You can control the default permission not only 600.</li>
  <li>Can change log level which was outputted Text log or syslog freely. For example, it can change log message ERROR level to INFO level. It is useful in missed operations.</li>
  <li>We can set not to output log message which is specified user which is like database admin.</li>
</ul>

<h3 id="features-alert">Alert Function</h3>
<p>
If database statistics is over threshold which was set by user, pg_statsinfo detect and write alert log in postgresql-log(message level is 'ALERT').
</p>

<p>
Alert function can set following alert parameter:
</p>
<ul>
  <li>rollback / seconds </li>
  <li>commit / seconds</li>
  <li>garbage data size (MB)</li>
  <li>garbage data size ratio(%)</li>
  <li>garbage data size ratio in each tables (%)</li>
  <li>average response time of queries (sec)</li>
  <li>longest response time of queries (sec)</li>
  <li>correlations of each tables (%)</li>
  <li>maximum number of backends</li>
  <li>empty disk space in table space (%)</li>
  <li>load average</li>
  <li>usage of disk swap (KB)</li>
  <li>amount of replication delay (MB)</li>
</ul>

<p>
(*1) Correlation of table is judged by only clustered table which is in cluster index.
</p>

<p>
How to set alert function, Please read <a href="#usage-alert">following passage</a>.
</p>

<h3 id="features-cmdline">Features of Command-line</h3>
<p>
pg_statsinfo provide features that are creating reports and operations in command-line.<br>
* How to use feature of command-line, Read <a href="#usage-cmdline">this section</a>.
</p>

<h4>Feature of creating report in command-line</h4>
<p>
This feature provide the create reporting command which create report from a repository database in your set period.<br>
And it can also manage snapshots management in repository database.
</p>

<ul>
  <li>Show list of snapshot</li>
  <li>Show sum of snapshot size</li>
</ul>

<p>
Introduction of feature of creating report in command-line is <a href="files/pg_statsinfo_v2.5_report_infomation.xls">"report item list of pg_statsinfo v2.5".</a><br>
And outputted report items are same as <a href="http://pgstatsinfo.projects.postgresql.org/pg_stats_reporter-ja.html">pg_stats_reporter</a>.<br>
If you would like to output graphical reports, please use <a href="http://pgstatsinfo.projects.postgresql.org/pg_stats_reporter-ja.html">pg_stats_reporter</a>.
</p>

<h4>Operation feature</h4>
<p>
pg_statsinfo also provide operation for repository server in command-line.<br>
Providing features are under following.
</p>

<ul>
  <li>Get snapshot manually</li>
  <li>Delete snapshot in repository server</li>
  <li>Stop pg_statsinfo's agent</li>
  <li>Start pg_statsinfo's agent</li>
</ul>
<br>

<h3 id="features-maintenance">Auto maintenance feature</h3>
<p>pg_statsinfo execute auto maintenance at once every day. Executing operation is under following.
<ul>
  <li>Delete old snapshots which are over stored period.</li>
  <li>Arrangement PostgreSQL log files</li>
</ul>

<p>It is default ON and is executed in regular time.</p>
<p>
(*1) When stopping feature of auto deleting snapshots, old snapshots are not deleted in repository server. So please delete snapshot manually in regularly.<br>
(*2) When stopping feature of auto maintenance log files, old log files are not deleted in repository server. Please delete log files manually in regularly.
</p>

<p>
How to use feature of auto maintence is <a href="#usage-maintenance">here</a>.
</p>

<h2 id="install">Install</h2>

<h3 id="requirement">Requirement</h3>
<dl>
<dt>PostgreSQL versions</dt>
<dd>PostgreSQL 8.3, 8.4, 9.0, 9.1, 9.2, 9.3 (required --with-libxml configure option. RPM's default setting is with --with-libxml option.)</dd>
<dt>OS</dt>
<dd>RHEL 5.x, 6.x, CentOS 5.x, 6.x</dd>
<dt>Required connections</dt>
<dd>1 connection for the monitored instance / 1 connections for repository.<br/>
2 connections required if monitored instance and repository are in the same server.</dd>
</dl>

<h3 id="procedure">Instlation</h3>

<h4>RPM</h4>
This example is How to install PostgreSQL9.2 x86_64 rpm.
<pre>
$ su
# rpm -ivh pg_statsinfo-2.5.0-1/pg92.rhel6.x86_64.rpm
</pre>

<h4>Source</h4>

<p>You can use pgxs to bulld the module from the source codes.
You don't have to run sql files manually because pg_statsinfo installs them automatically for both monitored instances and repositories.</p>

<pre>
$ cd pg_statsinfo
$ tar xzvf pg_statsinfo-2.5.0.tar.gz 
$ cd pg_statsinfo-2.5.0
$ make USE_PGXS=1
$ su
# make USE_PGXS=1 install
</pre>

<p>Note: RPMs of PostgreSQL 9.0, 9.1, 9.2 change the install directory path. Therefore, the RPM of pg_statsinfo also changes install paths. For example, executable files are installed to "/usr/bin" previously. But from PostgreSQL9.0, these files are installed to "/usr/pgsql-9.0/bin".</p>

<h3 id="install">Configuration</h3>
This section is configuration of pg_statsinfo.

<h4 id="install">Configuration of postgresql.conf</h4>
First, you check the observation postgresql is stopped.
This configuration method is that snapshot repository is same instance in a PostgreSQL database. If you want to config other setting, you read <a href="#configuration">this section</a>.

<pre>
#minimam configuration
shared_preload_libraries = 'pg_statsinfo'       # preload pg_statsinfo libraries
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # pg_statsinfo need this log_filename setting
</pre>

<pre>
#recommended configuration
shared_preload_libraries = 'pg_statsinfo'       # preload pg_statsinfo libraries
custom_variable_classes = 'pg_statsinfo'

pg_statsinfo.snapshot_interval = 30min          # set snapshot interval 
pg_statsinfo.enable_maintenance = 'on'          # enable maintenance mode('on' or 'off')
pg_statsinfo.maintenance_time = '00:02:00'      # Delete old snapshots every day in this time.
pg_statsinfo.repository_keepday = 7             # keep old snapshots in this period in maintenance.

log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # pg_statsinfo need this log_filename setting
log_min_messages = 'log'
pg_statsinfo.syslog_min_messages = 'error'
pg_statsinfo.textlog_line_prefix = '%t %p %c-%l %x %q(%u, %d, %r, %a) '  # This format is same as syslog's format.
pg_statsinfo.syslog_line_prefix = '%t %p %c-%l %x %q(%u, %d, %r, %a) '   # This format is same as syslog's format.

track_functions = 'all'
log_checkpoints = on
log_autovacuum_min_duration = 0
#pg_statsinfo.long_lock_threashold = 30s        #threthold parameter for getting LOCK infomation
</pre>

<p>Attention in pg_statsinfo</p>
<dl>
  <dt>log_destination</dt>
  <dd>Force-set 'csvlog', stderr is eliminated.</dd>
  <dt>logging_collector</dt> 
  <dd>Force-set on.</dd>
</dl>

<h4>Configration of pg_hba.conf</h4>
<p>
Allow the user who run the PostgreSQL server to login the server without any passwords from localhost.
The recommended method is "ident" authentication here.
Add the following line to <a href="http://developer.postgresql.org/pgdocs/postgres/auth-pg-hba-conf.html">pg_hba.conf</a> when you use "OS-user = DB-superuser = postgres", that is the most common case.
Note that you will need to add it in pg_hba.conf in front of other methods.
The ident authentication method with TYPE=local will be convenient on UNIX.
</p>

<pre>
# TYPE  DATABASE        USER            CIDR-ADDRESS            METHOD [for UNIX]
local   all             postgres                                ident
</pre>

<p>Finally, setup postgresql.conf with the following setting when the monitored PostgreSQL instance stops.
In this settings, the repository will be created in 'postgres' database on the same server with monitored database.
See also "<a href="#configuration">Configuration File</a>" for other setting parameters.</p>

<pre>
log_checkpoints = on                      # record checkpoint activities
log_autovacuum_min_duration = 0           # record autovacuum activities
shared_preload_libraries = 'pg_statsinfo' # preload the library
</pre>

<p>
In addition, contrib/pg_statsinfo.sql and contrib/pg_statsrepo.sql are installed automactically. So, you don't need to install them manually. </p>

<h4>Configuration of input query statistic</h4>
<p>
Also, if you use PostgreSQL 8.4 or later, <a href="http://developer.postgresql.org/pgdocs/postgres/pgstatstatements.html">pg_stat_statements</a> is installed in 'postgres' database in the monitored instance, pg_statsinfo gathers the query statistics and add them into snapshot.
If you will use it, run the following command only once at the fist server start.
</p>

<pre>
# If you use PostgreSQL 9.1 or higher,
$ psql -d postgres -c "CREATE EXTENSION pg_stat_statements"

# If you use PostgreSQL 9.0 or lower,
$ psql -d postgres -f $PGSHARE/contrib/pg_stat_statements.sql
</pre>

<p>Please set under following parameters in postgresql.conf, if it is needed.</p>
<ul>
  <li>pg_statsinfo.stat_statements_max</li>
  <li>pg_statsinfo.stat_statements_exclude_users</li>
</ul>
<p>Explanation of above parameters are <a href="#configuration">Configuration</a>.</p>

<p>That's all. Install is finished.</p>

<h2 id='usage'>Usage</h2>
<p>This section is explained maintenance and configuration in pg_statsinfo.</p>

<h3 id="start-or-stop">Start or Stop</h3>

<p>You only have to start PostgreSQL server when you start pg_statsinfo.
pg_statsinfo will be kicked to start by the server;
It cannot run in standalone.</p>
<pre>$ pg_ctl start [OPTIONS]</pre>

<p>Also pg_statsinfo automatically stops when PostgreSQL server shutdowns.
Non-smart shutdown with 'pg_ctl stop -m fast|immediate' might cause some error messages, but you can ignore those errors.</p>
<pre>$ pg_ctl stop -m smart [OPTIONS]</pre>

<p>If you would like to stop only pg_statsinfo's agent not with PostgreSQL server, execute under following command.</p>
<pre>$ pg_statsinfo --stop [OPTIONS]</pre>

<p>If you would like to start agent again, execute under following command.</p>
<pre>$ pg_statsinfo --start [OPTIONS]</pre>

<p><b>(*1) If you don't set "shared_preload_libraries = 'pg_statsinfo'" in postgresql.conf before starting postgres, you cannot stop and start pg_statsinfo's agent.</b></p>

<h3 id="snapshot">Get or maintenance snapshot</h3>
<h4>Automatic snapshot</h4>
<p>
Pg_statsinfo gets snapshot every interval time.
Interval time configuration is in the following.
</p>

<p>example: snapshot interval time is 30min</p>
<pre>pg_statsinfo.snapshot_interval = 30min </pre>

<h4>Manual snapshot</h4>
<p>
If you want to get snapshot manualy, you use SQL statsinfo.snapshot function(text DEFAULT NULL).
</p>
<pre>$ psql -d postgres -c "SELECT statsinfo.snapshot('comment')"</pre>

<h4>Delete snapshots automaticaly</h4>
<p>Feature of auto maintenance can delete old snapshot automaticaly.<br>
Default setting is ON.</p>
<p>How to use feature of auto maintence is <a href="#usage-maintenance">here</a>.</p>

<h4>Delete snapshots manualy</h4>
<p>If you delete snapshots by munual, execute statsinfo.maintenance(timestamptz) function in psql.
Delete old snapshots which you set timestamps before.</p>

<p>Command example: Delete older snapshots than 2011-02-01 07:00:00.</p>
<pre>$ psql -d postgres -c "SELECT statsinfo.maintenance('2010-02-01 07:00:00'::timestamptz);"</pre>

<h4>Log files arrangement by feature of auto maintenance log files</h4>
<p>It can arrange log files automatically by feature of auto maintenance log files.<br>
It is default ON.</p>
<p>How to use auto maintence log files is <a href="#usage-maintenance">here</a>.</p>

<h3 id="usage-alert">Usage of Alert Function</h3>
<p>
In default setting, Alert function is always ON in each instance.
<br>
</p>

<h4>Change Alert Settings</h4>
<p>
You can change the threshold of alert function and ON or OFF function.<br/>
And if you set off or (-1) alert setting, it can stop only part of alert functions.
</p>

<p>
If you want to change the threshold of alert function, you should update the alert function table.<br/>
And alert function is executed every snapshot and in more two snapshots in the repository server.
</p>

Example: Set ROLLBACK / sec thereshold to 3000.
<pre>
# UPDATE statsrepo.alert SET commit_tps = 3000 WHERE instid = &lt;instance ID\&gt;
</pre>

Example: Disabled alert of rollback / sec.
<pre>
# UPDATE statsrepo.alert SET rollback_tps = -1 WHERE instid = &lt;instance ID\&gt;
</pre>

Exmaples: Disable Alert Function
<pre>
# UPDATE statsrepo.alert SET enable_alert = false WHERE instid = &lt;instance ID&gt;
</pre>

<h4>Infomation of Alert Setting Table</h4>
<p>
Alert setting table is stored alert function parameter and disable of enable
 information.
<br>
Alert setting table is "statsrepo.alert". And, setting table's schema is in following:
<br>
</p>

<table>
<thead>
  <tr>
    <th>column</th>
    <th>data type</th>
    <th>default parameter</th>
    <th>explanation</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>instid</td>
    <td>bigint</td>
    <td> - </td>
    <td>instance ID</td>
  </tr>
  <tr>
    <td>rollback_tps</td>
    <td>bigint</td>
    <td>100</td>
    <td>ROLLBACK / sec</td>
  </tr>
  <tr>
    <td>commit_tps</td>
    <td>bigint</td>
    <td>1000</td>
    <td>COMMIT / sec</td>
  </tr>
  <tr>
    <td>garbage_size</td>
    <td>bigint</td>
    <td>20000</td>
    <td>garbage size (MB)</td>
  </tr>
  <tr>
    <td>garbage_percent</td>
    <td>integer</td>
    <td>30</td>
    <td>percentage of garbage size ratio(%)</td>
  </tr>
  <tr>
    <td>response_avg</td>
    <td>bigint</td>
    <td>10</td>
    <td>average time of query responce (sec)</td>
  </tr>
  <tr>
    <td>response_worst</td>
    <td>bigint</td>
    <td>60</td>
    <td>longest time of query responce (sec)</td>
  </tr>
  <tr>
    <td>fragment_percent</td>
    <td>integer</td>
    <td>70</td>
    <td>correlations in each tables(%)</td>
  </tr>
  <tr>
    <td>backend_max</td>
    <td>integer</td>
    <td>100</td>
    <td>Maximum number of backend</td>
  </tr>
  <tr>
    <td>disk_remain_percent</td>
    <td>integer</td>
    <td>20</td>
    <td>Ratio of disk space in table space(%)</td>
  </tr>
  <tr>
    <td>loadavg_1min</td>
    <td>real</td>
    <td>7.0</td>
    <td>Load average@1min</td>
  </tr>
  <tr>
    <td>loadavg_5min</td>
    <td>real</td>
    <td>6.0</td>
    <td>Load average@5min</td>
  </tr>
  <tr>
    <td>loadavg_15min</td>
    <td>real</td>
    <td>5.0</td>
    <td>Load average@15min</td>
  </tr>
  <tr>
    <td>swap_size</td>
    <td>integer</td>
    <td>1000000</td>
    <td>Amount of disk swap(KB)</td>
  </tr>
  <tr>
    <td>rep_flush_delay</td>
    <td>integer</td>
    <td>100</td>
    <td>Amount of replication delay(MB)</td>
  </tr>
  <tr>
    <td>rep_replay_delay</td>
    <td>integer</td>
    <td>200</td>
    <td>Amount of recovery delay in standby server(MB)</td>
  </tr>
  <tr>
    <td>enable_alert</td>
    <td>boolean</td>
    <td>true</td>
    <td>enable or disabele for alert function (TRUE is enable and FALSE is disable)
</td>
  </tr>
</tbody>
</table>

<p>
Please don't delete an alert table's tuple.<br>
If you delete the tuple, you can not set the alert function in the instance.
</p>

<h3 id="usage-cmdline">How to use pg_statsinfo in command-line.</h3>

<h4>Create report</h4>
<pre>
$ pg_statsinfo -r REPORTID [-i INSTANCEID] [-b SNAPID] [-e SNAPID] [-B DATE] [-E DATE] [-o FILENAME] [connection-options]
</pre>

<p>
Example of command is under following. Under following command example shows create report in the repository database which is, hostname is localhost, port number is 5432, database is postgres, and user is postgres.
</p>
<ul>
  <li>All of report items</li>
  <li>The report period is a snapshot of the beginning last from a snapshot</li>
  <li>Target monitored instances for creating reports are all</li>
  <li>The destination of the report is standard output</li>
</ul>

<pre>
$ pg_statsinfo  -r All -h localhost -d postgres -p 5432 -U postgres
</pre>

<dl>
  <dt>-r, --report=REPORTID</dt>
  <dd>Set kind of reports if you want to create.</dd>
  <dd>Can set under following kind of reports.</dd>
  <dd>More detail information is <a href="files/pg_statsinfo_v2.5_report_infomation.xls">Items of report in pg_statsinfo v2.5</a>.</dd>
  <dd>
    <ul>
      <li>Summary</li>
      <li>DatabaseStatistics</li>
      <li>InstanceActivity</li>
      <li>OSResourceUsage</li>
      <li>DiskUsage</li>
      <li>LongTransactions</li>
      <li>NotableTables</li>
      <li>CheckpointActivity</li>
      <li>AutovacuumActivity</li>
      <li>QueryActivity</li>
      <li>LockConflicts</li>
      <li>ReplicationActivity</li>
      <li>SettingParameters</li>
      <li>SchemaInformation</li>
      <li>Profiles</li>
      <li>All</li>
    </ul>
  </dd>
  <dd>Report ID cannot distinguish between upper and lowercase letters. It can permit designation by the shortest agreement from an initial.</dd>
  
  <dt>-i, --instid=INSTANCEID</dt>
  <dd>Set the monitored instance which you would like to create reports.</dd>
  <dd>This option can be omitted. If you doesn't set this parameter, default setting sets all of monitored instance in your repository database.</dd>
  
  <dt>-b, --beginid=SNAPID</dt>
  <dd>Set snapshot id which is begining of snapshot you would like to create report.</dd>
  <dd>This option can be omitted. If you doesn't set this parameter, default setting sets start of the snapshot in the monitored instance.  (*1) (*2)</dd>

  <dt>-e, --endid=SNAPID</dt>
  <dd>Set snapshot id which is end of snapshot you would like to create report.</dd>
  <dd>his option can be omitted. If you doesn't set this parameter, default setting sets end of the snapshot in the monitored instance. (*1) (*2)</dd>
  
  <dt>-B, --begindate=DATE</dt>
  <dd>Set date which is beginning of snapshot you would like to create report.(YYYY-MM-DD HH:MI:SS format)</dd>
  <dd>This option can be omitted. If you doesn't set this parameter, default setting sets start of snapshot in the monitored instance. (*1) (*2)</dd>
  
  <dt>-E, --enddate=DATE</dt>
  <dd>Set date which is end of snapshot you would like to create report.(YYYY-MM-DD HH:MI:SS format)</dd>
  <dd>This option can be omitted. If you doesn't set this parameter, default setting sets end of the snapshot in the monitored instance. (*1) (*2)</dd>
  
  <dt>-o, --output=FILENAME</dt>
  <dd>Set reports file name.</dd>
  <dd>This option can be omitted. If you doesn't set this parameter, default setting outputs stdout.</dd>
</dl>
*1: Can not set snapshot id and date in a same.
*2: If you ommit period of snapshot, default setting sets from 0:00 a.m. of the day before to the present. 

<br>

<h4>List of snapshot</h4>
<pre>
$ pg_statsinfo -l [-i INSTANCEID] [connection-options]
</pre>

<p>
Sample command is under following. Under following command example shows list of snapshots stored in sample database in the repository database which is, hostname is localhost, port number is 5432, database is postgres, and user is postgres.
</p>

<pre>
$ pg_statsinfo -l -h localhost -d postgres -p 5432 -U postgres
</pre>

<dl>
  <dt>-l, --list</dt>
  <dd>Show list of snapshots, if you select this option.</dd>
  
  <dt>-i, --instid=INSTANCEID</dt>
  <dd>Set instance id which you would like to see list of snapshots.</dd>
  <dd>This option can be omitted. If you doesn't set this parameter, default setting is showing all of the monitored instance.</dd>
</dl>

<br>

<h4>Show snapshot size</h4>
<pre>
$ pg_statsinfo -s [connection-options]
</pre>

<p>
Sample command is under following. The command example shows snapshots size in "sample" database stored in repository database which is, hostname is localhost, port number is 5432, database is postgres, and user is postgres.
</p>

<pre>
$ pg_statsinfo -s -h localhost -d postgres -p 5432 -U postgres
</pre>

<dl>
  <dt>-s, --size</dt>
  <dd>Show snapshot size, if you use this option.</dd>
</dl>

<br>

<h4>Get snapshot</h4>
<pre>
$ pg_statsinfo -S COMMENT [connection-options]
</pre>

<p>
Sample command is under following. The command example shows getting snapshots with comment from database which is, hostname is localhost, port number is 5432, database is postgres, and user is postgres.
</p>

<pre>
$ pg_statsinfo -S 'COMMENT' -h localhost -d postgres -p 5432 -U postgres
</pre>

<dl>
  <dt>-S, --snapshot=COMMENT</dt>
  <dd>If you set this option, get snapshot.</dd>
  <dd>Option argument is set comment of snapshot.</dd>
</dl>

<br>

<h4>Delete snapshot</h4>
<pre>
$ pg_statsinfo -D SNAPID [connection-options]
</pre>

<p>
Sample command is under following. The command example shows deleting snapshots from repository database which is, hostname is localhost, port number is 5432, database is postgres, and user is postgres.
</p>

<pre>
$ pg_statsinfo -D 123 -h localhost -d postgres -p 5432 -U postgres
</pre>

<dl>
  <dt>-D, --delete=SNAPID</dt>
  <dd>Delete snapshot which is set by the snapshot id.</dd>
  <dd>Option argument is set snapshot id which you want to delete.</dd>
</dl>

<br>

<h4>Stop pg_statsinfo's agent</h4>
<pre>
$ pg_statsinfo --stop [connection-options]
</pre>

<p>
Sample command is under following.<br>The command example shows stopping pg_statsinfo's agent in which is, hostname is localhost, port number is 5432, database is postgres, and user is postgres.
</p>

<pre>
$ pg_statsinfo --stop -h localhost -d postgres -p 5432 -U postgres
</pre>

<dl>
  <dt>--stop</dt>
  <dd>If we execute with this option, agent is going to stop.</dd>
</dl>

<br>

<h4>Start pg_statsinfo's agent.</h4>
<pre>
$ pg_statsinfo --start [connection-options]
</pre>

<p>
Command example is under following.<br>
Is in under following command sample, connect monitored instance to start agent in host name is localhost, port is 5432, database name is postgres, and connection user is postgres.
</p>

<pre>
$ pg_statsinfo --start -h localhost -d postgres -p 5432 -U postgres
</pre>

<dl>
  <dt>--start</dt>
  <dd>If you set this option, start pg_statsinfo's agent.</dd>
</dl>

<br>

<h4>Connection Options</h4>
<p>
Connect to database options is under following, it is same as PostgreSQL.<br>
If you would like to get snapshot, Set monitor instance. Or if you execute other purpose, set repository database.
</p>

<dl>
  <dt>-d, --dbname=DBNAME</dt>
  <dd>Set connecting database name.</dd>
  <dd>If you ommit this paramater, set "PGDATABASE" environment variable.<dd>
  <dd>And if you don't set environment variable, default is set your username which is used connect database.</dd>
  
  <dt>-h, --host=HOSTNAME</dt>
  <dd>Set host name which is working database server.</dd>
  <dd>If you set hostname stating "/", it is used UNIX domain socket.</dd>
  
  <dt>-p, --port=PORT</dt>
  <dd>Set tcp port which is monitored instance or UNIX domain socket file.</dd>
  
  <dt>-U, --username=USERNAME</dt>
  <dd>Set user name</dd>
  
  <dt>-w, --no-password</dt>
  <dd>If you connect database not to set password, set this option.</dd>
  
  <dt>-W, --password</dt>
  <dd>If you connect database to need to set password, fource to input password.  </dd>
</dl>

<br>

<h4 id="usage-maintenance">Automatic maintenance</h4>
<p>
If you want to maintain snapshot repository, you configure automatic maintenance mode in postgresql.conf.
Auto maintenance is executed every day.
Enable auto maintenance mode is in the following.
</p>
<pre>
pg_statsinfo.enable_maintenance = 'on'
pg_statsinfo.maintenance_time = '00:00:00'
pg_statsinfo.repository_keepday = 7
</pre>

<p>(*1) Feature of auto deleting snapshots is default ON.</p>
<p>(*2) When you use with feature of auto log files maintenance, please set pg_statsinfo.enable_maintenance = 'on' or pg_statsinfo.enable_maintenance = 'snapshot, log'.</p>
<p>(*3) If you don't use automatic maintenance mode, repository size will be very large. Plese maintenance repository manualy in every term.</p>
<p>(*4) If you use this setting in multi-monitoring instances with difference sttings, setting of deleting snapshot in repository server is set in shortest schedule.
For exmaple, when you set pg_statsinfo.repository_keepday which is under following in postgresql.conf to eahc server, monitoring instance3's configuration is reflect in the repository database server.</p>

<pre>
&lt;Monitoring instance1&gt;
pg_statsinfo.enable_maintenance = 'snapshot' 
pg_statsinfo.repository_keepday = 7
&lt;Monitoring instance2&gt;
pg_statsinfo.enable_maintenance = 'snapshot' 
pg_statsinfo.repository_keepday = 5
&lt;Monitoring instance3&gt;
pg_statsinfo.enable_maintenance = 'snapshot' 
pg_statsinfo.repository_keepday = 3
</pre>

<h4>Feature of auto log files maintenance</h4>
<p>pg_statsinfo can execute auto log files maintenance shell script at once every day. It is default ON and is executed in regular time.<br>
If you would like to enable this feature, set configuratoin in postgresql.conf.</p>

<p>Example: Compress CSV log files at 0:02 every day.</p>
<pre>
pg_statsinfo.enable_maintenance = 'log'     # auto maintenance settings
pg_statsinfo.maintenance_time = '00:02:00'  # time which is executed auto maintenance
pg_statsinfo.log_maintenance_command = '&ltPGHOME&gt/bin/archive_pglog.sh %l'  # Configuration of arrangement log files (*1)
</pre>
<p>(*1) &ltPGHOME&gt: install directory of PostgreSQL</p>
<p>(*2) archive_pglog.sh
archive_pglog.sh is included shell script in package of pg_statsinfo.
It compress CSV log files before one day in every day, and create compressed log file in log directory which is created by pg_statsinfo.
And also, it deletes CSV log files which have been moved by its shell script.</p>
<p>(*3) Feature of auto maintence is enable in default setting.</p>
<p>(*4) When you use with feature of auto log files maintenance, please set pg_statsinfo.enable_maintenance = 'on' or pg_statsinfo.enable_maintenance = 'snapshot, log'.</p>
<p>(*5) If you omit configuration of log maintenance command, above command is executed.</p>

<br>

<h3 id="configuration">Configuration File</h3>
<p>Configuration parameters and usages are explained in the section.</p>
<p>pg_statsinfo uses postgresql.conf in the monitored instance for a configuration file.
Settings in the configuration file are read at the instance's startup and reloads with 'pg_ctl reload'.</p>

<p>
You must setup the following parameters before using pg_statsinfo.
Some of the paramters cannot be changed online and require server's restart.
</p>

<table>
<caption>must-set parameters</caption>
<thead>
  <tr>
    <th>Name</th>
    <th>Setting</th>
    <th>Description</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>shared_preload_libraries</td>
    <td>'pg_statsinfo'</td>
    <td>Preloaded libraries.
        If you also use pg_stat_statements, append the module name with a comma like 'pg_statsinfo, pg_stat_statements'.</td>
  </tr>
  <tr>
    <td>log_filename</td>
    <td>'postgresql-%Y-%m-%d_%H%M%S.log'</td>
    <td>Must set this format. If you want to change file name, must set order in "%Y, %m, %d, %H, %M, %S" in file name.</td>
  </tr>
  <tr>
    <td>track_counts</td>
    <td>on</td>
    <td>Enables collection of statistics on database activity.</td>
  </tr>
  <tr>
    <td>track_activities</td>
    <td>on</td>
    <td>Enables the collection of information on the currently executing command of each session.</td>
  </tr>
  <tr>
    <td>log_min_messages</td>
    <td>debug5 &sim; log</td>
    <td>A message level threshoulds for server logs.
        The value must be more verbose than 'log', pg_statsinfo.syslog_min_messages, and pg_statsinfo.textlog_min_messages.</td>
  </tr>
  <tr>
    <td>log_timezone</td>
    <td>unknown, gmt, utc</td>
    <td>Only those values are supported.</td>
  </tr>
  <tr>
    <td>log_destination</td>
    <td>must have 'csvlog', and can have 'syslog' or 'eventlog' optionally</td>
    <td>pg_statsinfo always adds 'csvlog' and removes 'stderr' during startup.</td>
  </tr>
  <tr>
    <td>logging_collector</td>
    <td>on</td>
    <td>pg_statsinfo always set it to this value during startup.</td>
  </tr>
</tbody>
</table>

<p>There some optional parameters that affect pg_statsinfo's activities.
They can be changed online when reloaded with pg_ctl reload.

<p>If you use PostgreSQL 8.3, read 'pg_statsinfo.*' as 'statsinfo.*'.</p>

<table>
<caption>optional parameters</caption>
<thead>
  <tr>
    <th>Name</th>
    <th>Default Setting</th>
    <th>Description</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>track_functions</td>
    <td>none</td>
    <td>Enables tracking of function call counts and time used.
        Set to 'pl' or 'all' if you want pg_statsinfo to gather the statistics.</td>
  </tr>
  <tr>
    <td>track_io_timing</td>
    <td>off</td>
    <td>Collect statistics of read and write relation blocks and times. If you set would like to collect these stats, set on this parameter.<br>
        [caution] If this parameter set on, it might cause lessor parformance.<br>
        (This parameter can be set in PostgreSQL 9.2 or later.)</td>
  </tr>
  <tr>
    <td>log_checkpoints</td>
    <td>off</td>
    <td>Causes checkpoints to be logged in the server log.
       'on' is recommended.</td>
  </tr>
  <tr>
    <td>log_autovacuum_min_duration</td>
    <td>-1</td>
    <td>Causes autovacuums to be logged in the server log.
        0 &sim; 1min are recommended.</td>
  </tr>
  <tr>
    <td>log_directory</td>
    <td>'pg_log'</td>
    <td>A directory for csvlog and textlog files.</td>
  </tr>
  <tr>
    <td>log_filename</td>
    <td>'postgresql-%Y-%m-%d_%H%M%S.log'</td>
    <td>A file format for csvlog and textlog files.
        The value should be contain %Y, %m, %d, %H, %M, and %S in this order.</td>
  </tr>
  <tr>
    <td>log_rotation_age</td>
    <td>1d</td>
    <td>Rotates logs in the specified duration.</td>
  <tr>
  </tr>
    <td>log_rotation_size</td>
    <td>10MB</td>
    <td>Rotates logs in the specified file size.
        The size will be compared with csvlogs.</td>
  <tr>
  </tr>
  <tr>
    <td>syslog_facility</td>
    <td>'LOCAL0'</td>
    <td>syslog facility</td>
  </tr>
  <tr>
    <td>syslog_ident</td>
    <td>'postgres'</td>
    <td>syslog indent</td>
  </tr>
  <tr>
    <td>custom_variable_classes</td>
    <td>-</td>
    <td>Required when you set parameters that starts with "pg_statsinfo.".</td>
  </tr>
  <tr>
    <td>pg_statsinfo.textlog_min_messages</td>
    <td>warning</td>
    <td>Minimum message levels for textlog (*1).</td>
  </tr>
  <tr>
    <td>pg_statsinfo.syslog_min_messages</td>
    <td>disable</td>
    <td>Minimum message levels for syslog (*1).
        Event log is used on Windows instead of syslog.
    </td>
  </tr>
  <tr>
    <td>pg_statsinfo.textlog_filename</td>
    <td>'pg_statsinfo.log'</td>
    <td>Textlog filename. Should not be empty.</td>
  </tr>
  <tr>
    <td>pg_statsinfo.textlog_line_prefix</td>
    <td>'%t %p '</td>
    <td>A printf-style string that is output at the beginning of each textlog line. (*2)</td>
  </tr>
  <tr>
    <td>pg_statsinfo.syslog_line_prefix</td>
    <td>'%t %p '</td>
    <td>A printf-style string that is output at the beginning of each syslog line. (*2)
        Note that timestamp and process IDs appended by syslog is replaced to values of pg_statsinfo daemon.
        So, you need to add %t and %p to record the original values.
    </td>
  </tr>
  <tr>
    <td>pg_statsinfo.textlog_permission</td>
    <td>0600</td>
    <td>Permission setting for textlog files.</td>
  </tr>
  <tr>
    <td>pg_statsinfo.textlog_nologging_users</td>
    <td>-</td>
    <td>Text log filtering configuration. Exclude user for not to output pg_log.And if you would like to set multiple user, set values with separator ",".</td>
  </tr>
  <tr>
    <td>pg_statsinfo.sampling_interval</td>
    <td>5s</td>
    <td>sampling interval (*3)</td>
  </tr>
  <tr>
    <td>pg_statsinfo.snapshot_interval</td>
    <td>10min</td>
    <td>snapshot interval (*3)</td>
  </tr>
  <tr>
    <td>pg_statsinfo.excluded_dbnames</td>
    <td>'template0, template1'</td>
    <td>Unmonitored database names.</td>
  </tr>
  <tr>
    <td>pg_statsinfo.excluded_schemas</td>
    <td>'pg_catalog, pg_toast, information_schema'</td>
    <td>exclude schema when snapshots.</td>
  </tr>
  <tr>
    <td>pg_statsinfo.repository_server</td>
    <td>'dbname=postgres'</td>
    <td>Connection string to connect the repository (*4). You need to avoid password input.</td>
  </tr>
  <tr>
    <td>pg_statsinfo.adjust_log_level</td>
    <td>off</td>
    <tdConfiguration of changing server log message level</td>
  </tr>
  <tr>
    <td>pg_statsinfo.adjust_log_info</td>
    <td>-</td>
    <td>Configuration of SQLSTATE which is changing massage level for INFO(*5)</td>
  </tr>
  <tr>
    <td>pg_statsinfo.adjust_log_notice</td>
    <td>-</td>
    <td>Configuration of SQLSTATE which is changing massage level for NOTICE(*5)</td>
  </tr>
  <tr>
    <td>pg_statsinfo.adjust_log_warning</td>
    <td>-</td>
    <td>Configuration of SQLSTATE which is changing massage level for WARNING(*5)</td>
  </tr>
  <tr>
    <td>pg_statsinfo.adjust_log_error</td>
    <td>-</td>
    <td>Configuration of SQLSTATE which is changing massage level for ERROR(*5)</td>
  </tr>
  <tr>
    <td>pg_statsinfo.adjust_log_log</td>
    <td>-</td>
    <td>Configuration of SQLSTATE which is changing massage level for LOG(*5)</td>
  </tr>
  <tr>
    <td>pg_statsinfo.adjust_log_fatal</td>
    <td>-</td>
    <td>Configuration of SQLSTATE which is changing massage level for FATAL(*5)</td>
  </tr>
  <tr>
    <td>pg_statsinfo.enable_maintenance</td>
    <td>'on'</td>
    <td>Setting of auto_maintenance.
      <ul>
        <li>'snapshot': Delete snapshot</li>
        <li>'log': Clean log file</li>
        <li>'snapshot, log': Delete snapshot and clean log file</li>
        <li>'on': Delete snapshot and clean log file</li>
        <li>'off': none</li>
      </ul>
    </td>
  </tr>
  <tr>
    <td>pg_statsinfo.maintenance_time</td>
    <td>'00:02:00'</td>
    <td>Maintenance time of the snapshots in repository server.</td>
  </tr>
  <tr>
    <td>pg_statsinfo.repository_keepday</td>
    <td>7</td>
    <td>Maintenance period of snapshots in repository server.</td>
  </tr>
  <tr>
    <td>pg_statsinfo.log_maintenance_command</td>
    <td>&ltPGHOME&gt/bin/archive_pglog.sh %l</td>
    <td>This parameter is server log cleanup command. If we use default shell, old server log is decommpressed.</td>
  </tr>
  <tr>
    <td>pg_statsinfo.long_lock_threashold</td>
     <td>30s</td>
     <td>Threashold of getting LOCK infomation in pg_locks.</td>
  </tr>
  <tr>
    <td>pg_statsinfo.stat_statements_max</td>
    <td>30</td>
    <td>Upper limit of information in pg_stat_statements.</td>
  </tr>
  <tr>
    <td>pg_statsinfo.stat_statements_exclude_users</td>
    <td>-</td>
    <td>Exclude user in pg_stat_statements. If you want to set multi user, you use separator ','.</td>
  </tr>
  <tr>
    <td>pg_statsinfo.controlfile_fsync_interval</td>
    <td>1min</td>
    <td>Set regular intervals of fsync() contorol file of pg_statsinfo.</td>
  </tr>
</tbody>
</table>

<dl>
<dt>*1 : Message Levels</dt>
<dd>
The following values are available for message levels.
The specified level and more verbose messages are recorded in the logs.
"disable" will record no logs.
The order fo levels are same as <a href="http://www.postgresql.jp/document/8.3/html/runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHEN">log_min_messages</a> except additional "disable" and "alert" levels and "debug".
</dd>
<dd>disable &gt; alert &gt; panic &gt; fatal &gt; log &gt; error &gt; warning &gt; notice &gt; info &gt; debug</p></dd>

<dt>*2 : Prefix Format</dt>
<dd>Spefied with the same format with configuration parameter <a href="http://developer.postgresql.org/pgdocs/postgres/runtime-config-logging.html#GUC-LOG-LINE-PREFIX">log_line_prefix</a>.
Note that log_line_prefix itself is ignored when pg_statsinfo is enabled.
</dd>

<dt>*3 : Time Format</dt>
<dd>
Available units are d (day), h (hour), min (minite), and s (second).
If no unit, the value is interpreted as seconds.</dd>
<dd>Using pg_statsinfo in Postgresql 8.3, please set second unit(not nesessary 's').(ex. 3min = 180)<dd>

<dt>*4 : Connection String</dt>
<dd>
It is a libpq-style connection string.
For example, 'hostaddr=127.0.0.1 port=5432 dbname=mydb user=postgres'.
<b>Here, set username is superuser. </b>
See also PQconnectdb in "<a href="http://developer.postgresql.org/pgdocs/postgres/libpq-connect.html">Database Connection Control Functions</a>" for details.
In addition, <a href="http://developer.postgresql.org/pgdocs/postgres/libpq-envars.html">environment variables</a> used by libpq will be used.
</dd>
<dd>
You need to avoid password input to connect the repository.
If password is required, create <a href="http://developer.postgresql.org/pgdocs/postgres/libpq-pgpass.html">.pgpass</a> for the OS user who execute the local postgres server to connect the repository to automate password input.
And, If you use .pgpass file, please set host name in connection string to repository in "host=xxxx".
</dd>
<dt>*5 : SQLSTATE</dt>
<dd>
SQLSTATE is log state like '42P01' and '42P02'.
If you change this SQLSTATE for INFO log level, you set pg_statsinfo.adjust_log_info = '42P01,42P02'.
</dd>
</dl>

<h4>Reload Configuration Files</h4>
<p>If you want to reset configuration parameters online, just modify postgresql.conf and send a reload signal with pg_ctl.
</p>
<pre>$ pg_ctl reload</pre>

<h3 id="user-operations">Needed operations</h3>
<p>This section is needed operations in install of pg_statsinfo system.</p>

<h4>Delete server's log</h4>
<p>Please delete old log files(CSV log, text log) every period, or use feature of auto log maintenance.</p>

<h4>Rotate Logs</h4>
<p>if you want to rotate logs in arbitrary time, execute the following function on the monitored instance.</p>
<pre>$ psql -d postgres -c "SELECT pg_rotate_logfile()"</pre>

<h4 id="on-abort">When abend was happened</h4>
<p>If pg_statsinfo's agent is stopped, it doesn't affect the PostgreSQL server. However,  agent have been stopped forever. If you would like to restart agent, restart your PostgreSQL server.
</p>

<h3 id="uninstall">Uninstall</h3>
<p>When you uninstall pg_statsinfo, you have to restart PostgreSQL server after removing 'pg_statsinfo' from <code>shared_preload_libraries</code> and all of <code>pg_statsinfo.*</code> parameters in postgresql.conf.
</p>

<p>After that, drop all objects used by pg_statsinfo installed in the monitored instance. Run $PGSHARE/contrib/uninstall_pg_statsinfo.sql for 'postgres' database in the monitored instance.</li>
<pre>$ psql -d postgres -f $PGSHARE/contrib/uninstall_pg_statsinfo.sql </pre>

<p>If you also want to delete snapshots, run $PGSHARE/contrib/uninstall_pg_statsrepo.sql to the repository.
Be careful to run the script file because it will delete all of snapshots including other server's ones when the repository was shared by multiple monitored instances.</p>

<pre>$ psql -d &lt;repository&gt; -f $PGSHARE/contrib/uninstall_pg_statsrepo.sql </pre>

<h2 id="restrictions">Restrictions</h2>
<p>There are still some restrictions and limitations in pg_statsinfo.</p>

<dl>
<dt>Requires the same encoding and lc_messages setting on all databases in the monitored instance</dt>
<dd>
pg_statsinfo supports encodings and message locales in PostgreSQL, but all of database in an instance must use the same encoding and locale because mixed-encoded server logs cannot be parsed correctly.
</dd>

<dt>Restrictions for log_filename</dt>
<dd>pg_statsinfo expects log_filename behaves as the following:
<ul>
  <li>Every restarts of the server always create new log files.
      (The logs must have 'seconds' unit in their filename.)</li>
  <li>Server log are named ascending order.</li>
</ul>
You also delete all of the server log files before you modify log_filename setting to avoid any new logs have smaller names than older logs.
</dd>

<dt>Restrictions for pg_statsinfo.textlog_filename</dt>
<dd>A fixed named textlog is always required.</dd>

<dt>log_timezone should be unknown, gmt, or utc</dt>
<dd>
Only those values are supported.
PostgreSQL uses own timezone implementation, but we cannot use it from an external program.
</dd>

<dt>Error messages in fast or immediate shutdown</dt>
<dd>Those error messages are not avoidable on PostgreSQL shutdown unless it is a smart shutdown.
</dd>

<dt>Cannot collect shutdown checkpoint logs</dt>
<dd>That't because the repository might be unavailable if it is in the same server with the monitored one.</dd>

<dt>Cannot deleting snapshot table and getting snapshot in same timing.</dt>
<dd>It might occure error when getting snapshot. However, if error is occured in getting snapshot, then it retry.</dd>

<dt>Settings of multi-monitoring instance</dt>
<dd>Cannot set all of same identifieres which are database id, host name, or port number in each instance. pg_statsinfo cannot recognize each instances.</dd>

<dt>Caution of feature of auto maintenance</dt>
<dd>In auto deleting snapshots, shortest period of deleting setting has most priority setting. It cannot work each settings in each monitoring instance. Please care of this rule.</dd>

<dt>Limitaion of getting amount of WAL statistics.</dt>
<dd>Amount of WAL statistics were not collected in a stanby server.</dd>

<dt>Other cautions in reports</dt>
<dd>There are rounding off fractions in reports. It will represent zero value if little bit value is existed.</dd>
</dl>
<br/>

<h2 id="QA">Q&A</h2>
<h4>Q1. How to confirm the method if pg_statsinfo works normal?</h4>
<p>
Pg_statsinfo gets snapshot and stores it in statsrepo schema. 
If you want to confirm if pg_statsinfo waorks normal, you can use under following SQL.
</p>
<pre>
$psql -d postgres -c "SELECT statsinfo.snapshot('test')"
$psql -d postgres -c "SELECT * FROM statsrepo.snapshot WHERE COMMENT = 'test'"
</pre>
<p>If you execute 2nd SQL and get result, pg_statsinfo works normal.</p>

<h4>Q2. How to use snapshots?</h4>
<p>Pg_statsinfo's snapshot function has only getting PostgreSQL's statistics every uniform regularly.
If you want to see useful and visual report from snapshot, you can use <a href='http://pgstatsinfo.projects.postgresql.org/pg_stats_reporter.html'>pg_stats_reporter</a>. 
Example of pg_repoter's output report is <a href='files/details.html'>here</a>.
</p>

<h4>Q3. Auto maintenance mode does not work well. </h4>
<p>
It might be auto maintenance configuration is off.
Confirm under following configuration in your postgresql.conf.
</p>

<dl>
  <dt>Propety configuration examples in postgresql.conf are here.</dt>
  <dd>Set one configuration in postgresql.conf, if you like.
    <ul>
      <li>pg_statsinfo.enable_maintenance = 'on'</li>
      <li>pg_statsinfo.enable_maintenance = 'snapshot'</li>
      <li>pg_statsinfo.enable_maintenance = 'snapshot, log'</li>
    </ul>
  </dd>
</dl>

<h4>Q4. How to confirm alert function works well.</h4>
<p>
Enable alert function in postgresql.conf and set commit alert threshold 0, finaly get snapshost in command line or automaticaly<br>
If it works collectly, alert messages were outpted in log messages.
</p>

<p>
Example setting SQL is under following.
</p>
<pre>
# UPDATE statsrepo.alert SET enable_alert = true, commit_tps = 0;
</pre>

<p>
After you confirm to work collectly, set propety value or default value.
</p>

<h4>Q5. Please tell me how to update from pg_statsinfo 2.x.</h4>
<p>
First, uninstall old version. Next, install new version.<br>
In new version, it cannot use snapshots which was get in old version. <br>
Please read <a href="#uninstall">Uninstall</a>, and drop old pg_statsinfo's schema.<br><br>
Then you restart postgres, it will be work.
</p>

<h4>Q6. It cannot create report by command-line.</h4>
<p>
It might not have snapshots in repository database or only stored two or less snapshots.<br>
It should need two over snapshots to create report. Please get snapshot more or wait for getting snapshot automaticaly, then create report.
</p>

<h4>Q7. It cannot create part of report by command-line.</h4>
<dl>
  <dt>Query Activity (Functions)</dt>
  <dd>It might set track_functions = none in postgresql.conf.</dd>
  <dd>In this settings, needed statistics isn't stored in repository database.</dd>
  <dd>Please change track_functions = none in postgreswl.conf.</dd>
  
  <dt>Query Activity (Statements)</dt>
  <dd>It might not install pg_stat_statements.</dd>
  <dd>For create this report item, install pg_stat_statements before operation.</dd>
  
  <dt>Autovacuum Activity</dt>
  <dd>It might set log_autovacuum_min_duration = -1 in postgresql.conf.</dd>
  <dd>In this case. it cannot create item of autovacuum in the report.</dd>
  <dd>If you would like to create this to report item, don't set "log_autovacuum_min_duration = -1".</dd>
  
  <dt>Checkpoint Activity</dt>
  <dd>It might set log_checkpoints = off in postgresql.conf.</dd>
  <dd>In this case, needed statistic was not stored in repository database.</dd>
  <dd>If you would like to create this report item, set "log_checkpoints = on" in postgresql.conf.</dd>
  
  <dt>OS Resource Usage (IO Usage)</dt>
  <dd>It might use NFS or other kind of storages which aren't block device.</dd>
  <dd>pg_statsinfo gets OS resources in /proc, therefore it doesn't support peculiar storages.</dd>
  
  <dt>Long Transactions</dt>
  <dd>It might not exist snapshot in your setting period.</dd>
  
  <dt>Notable Tables</dt>
  <dd>It might not exist snapshot in your setting period.</dd>
  
  <dt>Lock Conflicts</dt>
  <dd>It might not exist snapshot in your setting period.</dd>
  
  <dt>Replication Activity</dt>
  <dd>It might not exist snapshot in your setting period.</dd>
  
  <dt>Schema Information</dt>
  <dd>Confirm your database connecting setting and .pgpass. Client authentication is <a href="http://www.postgresql.jp/document/current/html/client-authentication.html">here</a>.</dd>
</dl>
<br>

<h2 id="change">Changes from pg_statsinfo 2.4</h2>
<p>pg_statsinfo 2.4 is changed under following points</p>
<ul>
  <li>Work in PostgreSQL 9.3.</li>
  <li>Add collective statistics under following.</li>
  <ul>
    <li>Maximum number of backend</li>
    <li>Unit of parameter values in postgresql.conf</li>
  </ul>
  <li>Change default pg_statsinfo outputed log file name to "pg_statsinfo.log".</li>
  <li>Add configuration which enable or disable alert functions, it can set each alert item freely.</li>
  <li>Add under following alert function</li>
  <ul>
    <li>correlations in each tables</li>
    <li>maximum number of backends</li>
    <li>empty disk space in tablespace</li>
    <li>load average</li>
    <li>amount of disk swap</li>
    <li>amount of replication delay</li>
  </ul>
  <li>Change output checkpoint log and auto vacuum log messages in pg_statsinfo's text log. Before version is'nt output these log messages intentionally.</li>
  <li>Add collecting statistics in restartpoint in standby server</li>
  <li>Add fall-back mode if repository database server is not collectly working or not connecting. Before version, pg_statsinfo output error logs until fixed.</li>
  <li>Add report items in command-line reporting feature.</li>
  <ul>
    <li>amount of replication delay</li>
    <li>number of executed and execution time in auto analyze</li>
    <li>unit of parameter values in postgresql.conf</li>
  </ul>
  <li>Add command of pg_statsinfo agent operations.</li>
  <ul>
    <li>stop pg_statsinfo agent</li>
    <li>start pg_statsinfo agent</li>
  </ul>
</ul>
<br>

<h2 id="details">Details</h2>
<p>More advanced usages and internal structures are explained in the section.</p>

<h3 id="many-instances">Multiple Instance and One Repository System</h3>
<p>
We can set Multiple instance and One Repository system.
If you want to set the systems, you set following parameter in each instance and <a href='http://www.postgresql.org/docs/current/static/auth-methods.html'>less password setting in repository</a>.
</p>

<pre>pg_statsinfo.repository_server = 'hostaddr=192.168.0.32 port=5432 user=postgres dbname=postgres'</pre>

<h3 id="warm-standby">Warm Standby</h3>
<p><a href="http://developer.postgresql.org/pgdocs/postgres/warm-standby.html">Warm standby</a> can be used together with pg_statsinfo.
There are two typical setups for warm standby mode.
See also "<a href="pg_statsinfo-warm-standby.html">pg_statsinfo: warm-standby</a>" for details.
</p>

<ol>
  <li>Setup another repository server independent from active and standby servers.</li>
  <li>Place repositories for each active and standby servers.</li>
</ol>

<h3 id="internal">Internals</h3>
<p>pg_statsinfo consists of a library and a daemon. The library is loaded by PostgreSQL server, and the daemon is run as a database client.
Since the daemon is executed from a hook function in the library, users don't have to execute the daemon explicitly.
See also "<a href="pg_statsinfo-internal.html">pg_statsinfo: internal</a>" for details.
</p>

<h2 id="seealso">See Also</h2>
<a href="http://developer.postgresql.org/pgdocs/postgres/app-pg-ctl.html">pg_ctl</a>,
<a href="http://developer.postgresql.org/pgdocs/postgres/app-psql.html">psql</a>,
<a href="http://developer.postgresql.org/pgdocs/postgres/runtime-config.html">Server Configuration</a>,
<a href="http://developer.postgresql.org/pgdocs/postgres/monitoring-stats.html">The Statistics Collector</a>,
<a href="http://developer.postgresql.org/pgdocs/postgres/catalogs.html">System Catalogs</a>,
<a href="http://developer.postgresql.org/pgdocs/postgres/pgstatstatements.html">pg_stat_statements</a>,
<a href="http://pgstatsinfo.projects.postgresql.org/pg_stats_reporter.html">pg_stats_reporter</a>

<hr />
<div class="navigation">
  <a href="index.html">Top</a> &gt;
  <a href="pg_statsinfo.html">pg_statsinfo</a>
<div>
<p class="footer">Copyright (c) 2009-2013, NIPPON TELEGRAPH AND TELEPHONE CORPORATION</p>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try{
var pageTracker = _gat._getTracker("UA-10244036-6");
pageTracker._trackPageview();
} catch(err) {}
</script>
</body>
</html>

<style type="text/css">
div.imagebox {
float: left;
text-align: center;
margin: 0.5em 3px 1em 3px;
}
p.image, p.caption {
text-align: center;
margin: 5px;
}
p.caption {
font-size: 16px;
color: #000000;
}
p.clear {
clear: both;
}
</style>
